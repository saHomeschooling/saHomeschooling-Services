<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SA Homeschooling – Onboarding</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,800;0,900;1,700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    /* ----- consistent theme (homepage tokens) ----- */
    :root {
      --accent:        #c0234a;
      --accent-dark:   #96183a;
      --accent-light:  #f5d0d8;
      --dark:          #111111;
      --mid:           #3a1a22;
      --muted:         #6b6b6b;
      --light-bg:      #f8f4f5;
      --white:         #ffffff;
      --border:        rgba(0,0,0,0.09);
      --shadow-sm:     0 1px 4px rgba(0,0,0,0.07);
      --shadow-md:     0 4px 20px rgba(0,0,0,0.10);
      --shadow-lg:     0 12px 48px rgba(0,0,0,0.14);
      --radius:        8px;
      --radius-lg:     12px;
      --header-h:      68px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--white);
      color: var(--dark);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      background: var(--light-bg);
    }
    a { color: inherit; text-decoration: none; }
    button { cursor: pointer; font-family: inherit; border: none; background: none; }
    .container { max-width: 1280px; margin: 0 auto; padding: 0 32px; }

    /* ----- header (exact copy from home) ----- */
    header {
      position: sticky; top: 0; z-index: 1000;
      height: var(--header-h);
      background: var(--accent);
    }
    .nav-inner {
      height: 100%;
      display: flex; justify-content: space-between; align-items: center;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-divider { width: 2px; height: 30px; background: rgba(255,255,255,0.5); border-radius: 1px; }
    .brand-text { display: flex; flex-direction: column; line-height: 1.15; }
    .brand-name {
      font-family: 'Playfair Display', serif;
      font-weight: 800; font-size: 1rem; color: #fff; letter-spacing: 0.2px;
    }
    .brand-tag { font-size: 0.66rem; color: rgba(255,255,255,0.65); font-weight: 500; letter-spacing: 0.5px; }

    .nav-links { display: flex; align-items: center; gap: 2px; }
    .nav-links a {
      padding: 8px 14px; border-radius: 5px;
      font-weight: 600; font-size: 0.85rem;
      color: rgba(255,255,255,0.85); transition: all 0.15s;
    }
    .nav-links a:hover { color: #fff; background: rgba(255,255,255,0.1); }

    .nav-ctas { display: flex; align-items: center; gap: 8px; }
    .btn-ghost-nav {
      padding: 7px 16px; border-radius: 5px;
      border: 1.5px solid rgba(255,255,255,0.45);
      background: transparent; color: #fff;
      font-weight: 600; font-size: 0.85rem; transition: all 0.15s;
    }
    .btn-ghost-nav:hover { border-color: #fff; background: rgba(255,255,255,0.1); }
    .btn-solid-nav {
      padding: 7px 18px; border-radius: 5px;
      background: #fff; color: var(--accent);
      font-weight: 700; font-size: 0.85rem;
      border: none; transition: all 0.15s;
    }
    .btn-solid-nav:hover { background: var(--accent-light); }

    /* ----- onboarding lead ----- */
    .onboarding-lead {
      background: linear-gradient(145deg, #1e0a12 0%, #2c111f 100%);
      padding: 42px 0 24px;
      border-bottom: 4px solid var(--accent);
    }
    .onboarding-lead h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.8rem,4vw,2.8rem);
      font-weight: 900;
      color: #fff;
      margin-bottom: 8px;
    }
    .step-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      color: rgba(255,255,255,0.6);
      font-weight: 500;
    }
    .step-indicator .step-progress {
      background: rgba(255,255,255,0.15);
      border-radius: 100px;
      height: 8px;
      flex: 1;
      max-width: 260px;
    }
    .step-progress-fill {
      width: 14%;
      height: 8px;
      background: var(--accent);
      border-radius: 100px;
    }
    .step-number {
      background: rgba(255,255,255,0.1);
      padding: 5px 14px;
      border-radius: 40px;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #fff;
    }

    /* ----- form panel (card) ----- */
    .form-panel {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      max-width: 880px;
      margin: 50px auto 70px;
      padding: 40px 48px;
      border: 1px solid var(--border);
    }
    .step-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--dark);
      margin-bottom: 8px;
    }
    .step-desc {
      color: var(--muted);
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 18px;
      margin-bottom: 28px;
    }

    /* ----- forms – unified input styles ----- */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px 24px;
    }
    .full-width { grid-column: span 2; }
    .field {
      display: flex;
      flex-direction: column;
      gap: 5px;
      position: relative;
    }
    .field label {
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--mid);
    }
    .field label i { color: var(--accent); width: 16px; }
    .field input, .field select, .field textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      color: var(--dark);
      background: #fff;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s;
    }
    .field input:focus, .field select:focus, .field textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(192,35,74,0.1);
    }
    .field input[type="file"] { padding: 8px 10px; background: #fafafa; }

    /* password eye */
    .password-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .password-wrapper input {
      flex: 1;
      padding-right: 40px;
    }
    .toggle-pw {
      position: absolute;
      right: 12px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1rem;
      cursor: pointer;
      padding: 0 6px;
    }
    .toggle-pw:hover { color: var(--accent); }

    .hint {
      font-size: 0.7rem;
      color: var(--muted);
    }
    .checkbox-group, .multi-select {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 20px;
      background: #fbfbfb;
      padding: 12px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      font-weight: 400;
      text-transform: none;
      color: var(--dark);
      white-space: nowrap;         /* fixes word break issues */
    }
    .checkbox-group input[type="checkbox"], 
    .checkbox-group input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      flex-shrink: 0;
    }
    /* allow wrapping only for very small screens */
    @media (max-width: 500px) {
      .checkbox-group label { white-space: normal; }
    }

    /* inline other language field */
    .other-language-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }
    .other-language-row input {
      flex: 1;
      padding: 8px 12px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
    }

    .inline-row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
    }
    .inline-row .field { flex: 1 1 140px; }

    /* navigation buttons */
    .form-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 38px;
      gap: 15px;
    }
    .btn-prev, .btn-next, .btn-submit {
      padding: 14px 32px;
      border-radius: var(--radius);
      font-weight: 700;
      font-size: 0.95rem;
      transition: all 0.15s;
      border: none;
    }
    .btn-prev {
      background: #eaeef2;        /* lighter, not greyed out */
      color: var(--dark);
      border: 1px solid var(--border);
    }
    .btn-prev:hover { background: #dde2e6; color: #000; }
    .btn-next, .btn-submit {
      background: var(--accent);
      color: #fff;
      box-shadow: var(--shadow-sm);
    }
    .btn-next:hover, .btn-submit:hover { background: var(--accent-dark); }
    .btn-submit { background: #0f7b6b; }
    .btn-submit:hover { background: #0b6356; }

    /* validation alert — now directly above the first input (right after step-desc) */
    .validation-alert {
      background: #fee9e9;
      border-left: 5px solid #c0234a;
      padding: 14px 18px;
      border-radius: var(--radius);
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      color: #a01b3a;
      font-size: 0.88rem;
    }
    .validation-alert i { font-size: 1.1rem; }

    /* toast */
    .toast {
      position: fixed; bottom: 22px; right: 22px;
      background: var(--dark); color: #fff;
      padding: 11px 18px; border-radius: var(--radius);
      font-size: 0.88rem; font-weight: 600;
      box-shadow: var(--shadow-lg);
      transform: translateY(60px); opacity: 0;
      transition: all 0.26s; z-index: 9999;
      display: flex; align-items: center; gap: 8px;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast i { color: #22c55e; }

    /* terms link & alignment fix for step7 */
    .terms-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #fbfbfb;
      padding: 12px 18px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    .terms-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      margin: 0;
    }
    .terms-checkbox label {
      font-size: 0.9rem;
      text-transform: none;
      font-weight: 500;
      color: var(--dark);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .terms-link {
      color: var(--accent);
      font-weight: 600;
      text-decoration: underline;
    }
    .terms-link:hover { color: var(--accent-dark); }

    /* responsive */
    @media (max-width: 720px) {
      .form-panel { padding: 28px 22px; }
      .form-grid { grid-template-columns: 1fr; }
      .full-width { grid-column: span 1; }
      .step-title { font-size: 1.5rem; }
    }
    @media (max-width: 480px) {
      .container { padding: 0 16px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav-inner">
      <a href="#" class="brand">
        <div class="brand-divider"></div>
        <div class="brand-text">
          <span class="brand-name">SA Homeschooling</span>
          <span class="brand-tag">Education Services</span>
        </div>
      </a>
      <nav class="nav-links">
        <a href="#providers">Find Services</a>
        <a href="#how">How It Works</a>
        <a href="#list">List a Service</a>
        <a href="https://sahomeschooling.com" target="_blank">Magazine <i class="fas fa-arrow-up-right-from-square" style="font-size:0.65rem;"></i></a>
      </nav>
      <div class="nav-ctas">
        <a href="../pages/Login.html" class="btn-ghost-nav">Log In</a>
        <a href="../pages/registration.html" class="btn-solid-nav">Register</a>
      </div>
    </div>
  </header>

  <section class="onboarding-lead">
    <div class="container">
      <h1>Become a trusted provider</h1>
      <div class="step-indicator">
        <span class="step-number" id="stepCounter">Step 1 / 7</span>
        <div class="step-progress"><div class="step-progress-fill" id="stepProgressFill" style="width: 14%;"></div></div>
      </div>
    </div>
  </section>

  <!-- main form panel -->
  <div class="container">
    <div class="form-panel" id="formPanel">
      <div id="stepContainer"></div>
      <!-- validation alert will be moved by JS to sit right after step-desc -->
      <div id="validationAlert" class="validation-alert" style="display: none;"><i class="fas fa-exclamation-triangle"></i> <span id="alertMsg"></span></div>
      <div class="form-nav" id="formNav"></div>
    </div>
  </div>

  <div class="toast" id="toast"><i class="fas fa-check-circle"></i> <span id="toastMsg"></span></div>

  <script>
    (function() {
      // ---------- step definitions (exactly the same, except Step 7 default) ----------
      const steps = [
        { // step 1: Account Setup
          fields: [
            { type: 'text', label: 'Full Name / Business Name', name: 'fullName', required: true, col: 'full' },
            { type: 'email', label: 'Email Address', name: 'email', required: true, col: 'half' },
            { type: 'password', label: 'Password', name: 'password', required: true, col: 'half' },
            { type: 'select', label: 'Account Type', name: 'accountType', required: true, options: ['Individual Provider', 'Organisation / Company'], col: 'full' }
          ]
        },
        { // step 2: Provider Identity & Trust
          fields: [
            { type: 'file', label: 'Profile Photo / Logo', name: 'profilePhoto', accept: 'image/*', required: false, col: 'half' },
            { type: 'textarea', label: 'Short Bio (150–250 words)', name: 'bio', placeholder: 'Tell families about your approach...', required: true, col: 'full', rows: 3 },
            { type: 'number', label: 'Years of Experience', name: 'experience', required: true, col: 'half', min: 0, max: 60 },
            { type: 'file', label: 'Qualifications / Certifications (PDF or image)', name: 'certs', accept: '.pdf,.doc,.docx,.jpg,.png', required: false, col: 'half' },
            { type: 'file', label: 'Police Clearance (optional)', name: 'clearance', accept: '.pdf,.jpg,.png', required: false, col: 'half' },
            { type: 'multicheck', label: 'Languages Spoken', name: 'languages', options: ['English','Afrikaans','isiZulu','isiXhosa','Sepedi','Setswana','Sesotho','Xitsonga','SiSwati','Tshivenda','isiNdebele','Other'], required: false, col: 'full' }
          ]
        },
        { // step 3: Services Offered
          fields: [
            { type: 'select', label: 'Primary Category', name: 'primaryCat', required: true, options: ['Tutor','Therapist','Curriculum Provider','Online / Hybrid School','Educational Consultant','Extracurricular / Enrichment'], col: 'half' },
            { type: 'multicheck', label: 'Secondary Categories', name: 'secondaryCats', options: ['Tutor','Therapist','Curriculum','School','Consultant','Enrichment'], required: false, col: 'half' },
            { type: 'text', label: 'Service Title', name: 'serviceTitle', required: true, col: 'full' },
            { type: 'textarea', label: 'Service Description', name: 'serviceDesc', required: true, col: 'full', rows: 2 },
            { type: 'text', label: 'Subjects / Specialisations', name: 'subjects', placeholder: 'e.g. Mathematics, Phonics, OT', required: true, col: 'half' },
            { type: 'multicheck', label: 'Age Groups Served', name: 'ageGroups', options: ['5–7','8–10','11–13','14–18'], required: true, col: 'half' },
            { type: 'radio-group', label: 'Delivery Mode', name: 'deliveryMode', options: ['Online','In-person','Hybrid'], required: true, col: 'full' }
          ]
        },
        { // step 4: Location & Reach (with conditional radius)
          fields: [
            { type: 'text', label: 'City', name: 'city', required: true, col: 'half' },
            { type: 'select', label: 'Province', name: 'province', required: true, options: ['Eastern Cape','Free State','Gauteng','KwaZulu-Natal','Limpopo','Mpumalanga','Northern Cape','North West','Western Cape'], col: 'half' },
            { type: 'radio-group', label: 'Service Area', name: 'serviceArea', options: ['Local (X km)','National','Online only'], required: true, col: 'full' },
            { type: 'conditional-text', label: 'If local, specify radius (e.g. 30 km)', name: 'localRadius', placeholder: 'e.g. 30 km', required: false, col: 'half', dependsOn: 'serviceArea', dependsValue: 'Local (X km)' }
          ]
        },
        { // step 5: Pricing & Availability
          fields: [
            { type: 'select', label: 'Pricing Model', name: 'pricingModel', options: ['Hourly','Per package','Per term','Custom quote'], required: true, col: 'half' },
            { type: 'text', label: 'Starting Price (optional, e.g. R280/hr)', name: 'startingPrice', required: false, col: 'half' },
            { type: 'multicheck', label: 'Days available', name: 'daysAvailable', options: ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'], required: true, col: 'full' },
            { type: 'text', label: 'Time slots (e.g. 9am–2pm)', name: 'timeSlots', placeholder: 'e.g. 9am–2pm', required: true, col: 'full' }
          ]
        },
        { // step 6: Contact & Online Presence
          fields: [
            { type: 'tel', label: 'Phone Number', name: 'phone', required: true, col: 'half' },
            { type: 'tel', label: 'WhatsApp Number', name: 'whatsapp', required: false, col: 'half' },
            { type: 'email', label: 'Email for inquiries', name: 'inquiryEmail', required: true, col: 'full' },
            { type: 'url', label: 'Website', name: 'website', required: false, col: 'half' },
            { type: 'url', label: 'Social media link (e.g. Facebook)', name: 'social', required: false, col: 'half' }
          ]
        },
        { // step 7: Choose Your Listing Plan (default free selected)
          fields: [
            { type: 'radio-group', label: 'Select a plan', name: 'listingPlan', options: [
              'Free Listing – basic profile',
              'Professional Listing – R149/month (full contact, direct enquiries)',
              'Featured Partner – R399/month (homepage placement, analytics)'
            ], required: true, col: 'full', default: 'Free Listing – basic profile' },
            { type: 'terms-check', label: 'I agree to the Terms and Community Guidelines', name: 'terms', required: true, col: 'full' }
          ]
        }
      ];

      let currentStep = 1;
      const totalSteps = steps.length;
      let formData = {};

      const stepContainer = document.getElementById('stepContainer');
      const formNav = document.getElementById('formNav');
      const validationAlert = document.getElementById('validationAlert');
      const alertMsg = document.getElementById('alertMsg');
      const stepCounter = document.getElementById('stepCounter');
      const progressFill = document.getElementById('stepProgressFill');

      // Helper: show/hide alert and clear on typing
      function setupTypingClear() {
        document.querySelectorAll('#activeStepGrid input, #activeStepGrid select, #activeStepGrid textarea').forEach(el => {
          el.addEventListener('input', () => {
            validationAlert.style.display = 'none';
          });
          el.addEventListener('change', () => {
            validationAlert.style.display = 'none';
          });
        });
      }

      // Password toggle
      function attachPasswordToggle() {
        document.querySelectorAll('.toggle-pw').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const input = btn.parentElement.querySelector('input');
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            btn.innerHTML = type === 'password' ? '<i class="far fa-eye"></i>' : '<i class="far fa-eye-slash"></i>';
          });
        });
      }

      // "Other" language handler
      function attachOtherLanguageHandler() {
        const otherCheck = document.querySelector('input[name="languages"][value="Other"]');
        if (!otherCheck) return;
        const container = otherCheck.closest('.checkbox-group');
        let otherInputDiv = document.getElementById('otherLangInput');
        if (!otherInputDiv) {
          otherInputDiv = document.createElement('div');
          otherInputDiv.id = 'otherLangInput';
          otherInputDiv.className = 'other-language-row full-width';
          otherInputDiv.style.display = 'none';
          otherInputDiv.innerHTML = '<input type="text" placeholder="Specify other language" id="otherLangField">';
          container.parentElement.appendChild(otherInputDiv);
        }
        const otherTextField = document.getElementById('otherLangField');
        function toggleOther() {
          if (otherCheck.checked) {
            otherInputDiv.style.display = 'flex';
          } else {
            otherInputDiv.style.display = 'none';
            if (otherTextField) otherTextField.value = '';
          }
        }
        otherCheck.addEventListener('change', toggleOther);
        toggleOther();
        if (otherTextField) {
          otherTextField.addEventListener('input', () => {
            formData.otherLanguage = otherTextField.value;
          });
        }
      }

      // Conditional field for step4 (local radius)
      function attachConditionalHandler() {
        const radios = document.querySelectorAll('input[name="serviceArea"]');
        const localField = document.querySelector('.field.conditional-radius');
        if (!radios.length || !localField) return;
        function toggleLocal() {
          const selected = Array.from(radios).find(r => r.checked)?.value;
          if (selected === 'Local (X km)') {
            localField.style.display = 'flex';
          } else {
            localField.style.display = 'none';
            const input = localField.querySelector('input');
            if (input) input.value = '';
          }
        }
        radios.forEach(r => r.addEventListener('change', toggleLocal));
        toggleLocal();
      }

      function getStepTitle(step) { return ['Account Setup','Provider Identity & Trust','Services Offered','Location & Reach','Pricing & Availability','Contact & Online Presence','Choose Your Listing Plan'][step-1]; }
      function getStepDesc(step) { return ['Create your provider account','Build trust with qualifications','Tell families what you offer','Where can you serve families?','Set your rates and schedule','How families can reach you','Select a plan (free or premium)'][step-1]; }
      function getIcon(type) { return 'edit'; }

      function renderStep(step) {
        const stepDef = steps[step-1];
        let html = `<div class="step-title">Step ${step}: ${getStepTitle(step)}</div>
                    <div class="step-desc">${getStepDesc(step)}</div>`;
        // Insert validation alert right after step-desc (above first input)
        html += `<div id="validationAlertPlaceholder"></div>`;
        html += `<div class="form-grid" id="activeStepGrid">`;

        stepDef.fields.forEach(f => {
          const colClass = f.col === 'full' ? 'full-width' : '';
          let extraClass = '';
          if (f.type === 'conditional-text') extraClass = 'conditional-radius';
          html += `<div class="field ${colClass} ${extraClass}" data-field="${f.name}" style="${f.type==='conditional-text' ? 'display:none;' : ''}">`;
          html += `<label><i class="fas fa-${getIcon(f.type)}"></i> ${f.label} ${f.required ? '<span style="color:var(--accent);">*</span>' : ''}</label>`;

          if (f.type === 'select') {
            html += `<select name="${f.name}" ${f.required ? 'required' : ''}>`;
            html += `<option value="">-- Select --</option>`;
            f.options.forEach(opt => {
              const selected = (formData[f.name] === opt) ? 'selected' : '';
              html += `<option value="${opt}" ${selected}>${opt}</option>`;
            });
            html += `</select>`;
          }
          else if (f.type === 'textarea') {
            html += `<textarea name="${f.name}" placeholder="${f.placeholder || ''}" rows="${f.rows || 3}" ${f.required ? 'required' : ''}>${formData[f.name] || ''}</textarea>`;
          }
          else if (f.type === 'file') {
            html += `<input type="file" name="${f.name}" accept="${f.accept || '*'}" ${f.required ? 'required' : ''}>`;
          }
          else if (f.type === 'multicheck') {
            html += `<div class="checkbox-group" id="group-${f.name}">`;
            const savedArr = formData[f.name] || [];
            f.options.forEach(opt => {
              const checked = savedArr.includes(opt) ? 'checked' : '';
              html += `<label><input type="checkbox" name="${f.name}" value="${opt}" ${checked}> ${opt}</label>`;
            });
            html += `</div>`;
          }
          else if (f.type === 'radio-group') {
            html += `<div class="checkbox-group" style="gap:20px;">`;
            f.options.forEach(opt => {
              // If a default is provided and no value is stored, use default
              let checked = (formData[f.name] === opt) ? 'checked' : '';
              if (f.default && !formData[f.name] && opt === f.default) checked = 'checked';
              html += `<label><input type="radio" name="${f.name}" value="${opt}" ${checked} ${f.required ? 'required' : ''}> ${opt}</label>`;
            });
            html += `</div>`;
          }
          else if (f.type === 'terms-check') {
            html += `<div class="terms-checkbox">`;
            const checked = formData[f.name] ? 'checked' : '';
            html += `<input type="checkbox" name="${f.name}" ${checked} ${f.required ? 'required' : ''} id="termsBox">`;
            html += `<label for="termsBox">${f.label} – <a href="#" class="terms-link" onclick="window.open('/terms','_blank'); return false;">Read Terms & Guidelines</a></label>`;
            html += `</div>`;
          }
          else if (f.type === 'password') {
            html += `<div class="password-wrapper">`;
            html += `<input type="password" name="${f.name}" value="${formData[f.name] || ''}" ${f.required ? 'required' : ''}>`;
            html += `<button class="toggle-pw" type="button"><i class="far fa-eye"></i></button>`;
            html += `</div>`;
          }
          else if (f.type === 'conditional-text') {
            html += `<input type="text" name="${f.name}" placeholder="${f.placeholder || ''}" value="${formData[f.name] || ''}">`;
          }
          else {
            html += `<input type="${f.type}" name="${f.name}" placeholder="${f.placeholder || ''}" value="${formData[f.name] || ''}" ${f.required ? 'required' : ''}>`;
          }
          html += `</div>`;
        });
        html += `</div>`;
        stepContainer.innerHTML = html;

        // Move the existing validationAlert DOM node into the placeholder
        const placeholder = document.getElementById('validationAlertPlaceholder');
        if (placeholder) {
          placeholder.parentNode.insertBefore(validationAlert, placeholder.nextSibling);
          placeholder.remove();
        }

        attachPasswordToggle();
        if (step === 2) attachOtherLanguageHandler();
        if (step === 4) attachConditionalHandler();
        setupTypingClear();
      }

      function saveCurrentStepData() {
        const stepDef = steps[currentStep-1];
        stepDef.fields.forEach(f => {
          if (f.type === 'multicheck') {
            const checked = Array.from(document.querySelectorAll(`input[name="${f.name}"]:checked`)).map(c => c.value);
            formData[f.name] = checked;
          } else if (f.type === 'terms-check' || (f.type === 'checkbox' && !f.options)) {
            const el = document.querySelector(`[name="${f.name}"]`);
            if (el) formData[f.name] = el.checked;
          } else if (f.type === 'conditional-text') {
            const el = document.querySelector(`[name="${f.name}"]`);
            if (el) formData[f.name] = el.value;
          } else {
            const el = document.querySelector(`[name="${f.name}"]`);
            if (el && el.type !== 'file') formData[f.name] = el.value;
            else if (el && el.type === 'file' && el.files.length) formData[f.name] = el.files[0].name;
          }
        });
        if (currentStep === 2 && document.getElementById('otherLangField')) {
          formData.otherLanguage = document.getElementById('otherLangField').value;
        }
      }

      function validateStep(step) {
        const stepDef = steps[step-1];
        for (let f of stepDef.fields) {
          if (!f.required) continue;
          if (f.type === 'multicheck') {
            const checked = formData[f.name] || [];
            if (checked.length === 0) return f.label;
          } else if (f.type === 'terms-check' || f.type === 'checkbox') {
            if (!formData[f.name]) return f.label;
          } else if (f.type === 'radio-group') {
            if (!formData[f.name] || formData[f.name].trim() === '') return f.label;
          } else if (f.type === 'email') {
            const val = formData[f.name];
            if (!val || !/^\S+@\S+\.\S+$/.test(val)) return 'valid email';
          } else {
            const val = formData[f.name];
            if (!val || val.toString().trim() === '') return f.label;
          }
        }
        return null;
      }

      function nextStep() {
        saveCurrentStepData();
        const invalid = validateStep(currentStep);
        if (invalid) {
          alertMsg.innerText = `Please complete required field: ${invalid}`;
          validationAlert.style.display = 'flex';
          // Scroll to the very top of the step container (title + alert)
          document.querySelector('.step-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
          return;
        }
        validationAlert.style.display = 'none';
        if (currentStep < totalSteps) {
          currentStep++;
          updateStepDisplay();
        } else {
          finalSubmit();
        }
      }

      function prevStep() {
        saveCurrentStepData();
        validationAlert.style.display = 'none';
        if (currentStep > 1) {
          currentStep--;
          updateStepDisplay();
        }
      }

      function updateStepDisplay() {
        renderStep(currentStep);
        stepCounter.innerText = `Step ${currentStep} / ${totalSteps}`;
        progressFill.style.width = (currentStep / totalSteps * 100) + '%';
        let navHtml = '';
        if (currentStep > 1) navHtml += `<button class="btn-prev" id="prevBtn"><i class="fas fa-arrow-left"></i> Previous</button>`;
        else navHtml += `<div></div>`;
        if (currentStep < totalSteps) {
          navHtml += `<button class="btn-next" id="nextBtn">Next <i class="fas fa-arrow-right"></i></button>`;
        } else {
          navHtml += `<button class="btn-submit" id="submitBtn"><i class="fas fa-check-circle"></i> Create My Profile</button>`;
        }
        formNav.innerHTML = navHtml;
        document.getElementById('prevBtn')?.addEventListener('click', prevStep);
        document.getElementById('nextBtn')?.addEventListener('click', nextStep);
        document.getElementById('submitBtn')?.addEventListener('click', nextStep);
      }

      function finalSubmit() {
        saveCurrentStepData();
        const invalid = validateStep(currentStep);
        if (invalid) {
          alertMsg.innerText = `Please complete required field: ${invalid}`;
          validationAlert.style.display = 'flex';
          document.querySelector('.step-title').scrollIntoView({ behavior: 'smooth', block: 'start' });
          return;
        }
        showToast('Profile created successfully! Redirecting to dashboard...');
        setTimeout(() => window.location.href = '/dashboard/dashboard.html', 1500);
      }

      function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toastMsg').textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3500);
      }

      updateStepDisplay();
    })();
  </script>
</body>
</html>